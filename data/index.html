<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset='utf-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <title>ESP32 KNX Thermostat</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>ESP32 KNX Thermostat</h1>

    <hr>
    <h2>Status</h2>
    <p>Temperature: <span id="temperature">--</span>Â°C</p>
    <p>Humidity: <span id="humidity">--</span>%</p>
    <p>Pressure: <span id="pressure">--</span> hPa</p>

    <hr>
    <h2>Control</h2>
    <div class="control-section">
        <h3>Thermostat Control</h3>
        <div class="control-group">
            <label for="mode">Mode:</label>
            <select id="mode" onchange="setMode(this.value)">
                <option value="off">Off</option>
                <option value="on">On</option>
            </select>
        </div>
        <div class="control-group">
            <label for="setpoint">Temperature Setpoint:</label>
            <input type="number" id="setpoint" min="10" max="30" step="0.5" onchange="setSetpoint(this.value)">
        </div>
    </div>

    <hr>
    <h2>Configuration</h2>
    <form id="configForm">
        <input type="hidden" name="_csrf" value="${csrfToken}">
        Device Name: <input type="text" id="deviceName" name="deviceName" value="ESP32 Thermostat"><br><br>
        Update Interval (ms): <input type="number" id="updateInterval" name="updateInterval" value="10000" min="1000" step="1000"><br><br>
        KNX Address: <input type="text" id="knxAddress" name="knxAddress" pattern="\d{1,2}\.\d{1,2}\.\d{1,3}" value="1.1.1"><br><br>
        <button type="button" onclick="saveConfig()">Save Configuration</button>
    </form>

    <hr>
    <h2>System</h2>
    <button onclick="factoryReset()">Factory Reset</button>
    <button onclick="location.reload()">Refresh Page</button>

    <hr>
    <div id="errorLog" class="error"></div>

    <script>
    const csrfToken = '${csrfToken}';  // This will be replaced by the server

    // Simple error logging function
    function logError(error) {
        console.error(error);
        document.getElementById('errorLog').textContent = error.toString();
    }

    // Basic fetch wrapper with error handling
    async function fetchWithError(url, options = {}) {
        if (!options.headers) {
            options.headers = {};
        }
        options.headers['X-CSRF-TOKEN'] = csrfToken;
        const response = await fetch(url, options);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response;
    }

    // Update status values
    async function updateStatus() {
        try {
            const response = await fetchWithError('/status');
            const data = await response.json();
            
            document.getElementById('temperature').textContent = data.temperature.toFixed(1);
            document.getElementById('humidity').textContent = data.humidity.toFixed(1);
            document.getElementById('pressure').textContent = data.pressure.toFixed(1);
            document.getElementById('setpoint').value = data.setpoint.toFixed(1);
            document.getElementById('mode').value = data.enabled ? 'on' : 'off';
            
        } catch (error) {
            console.error('Failed to update status:', error);
        }
    }

    // Set temperature
    async function setSetpoint(value) {
        try {
            await fetchWithError('/setpoint', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: `setpoint=${value}`
            });
            updateStatus();
        } catch (error) {
            logError('Failed to set temperature: ' + error);
        }
    }

    // Set mode
    async function setMode(mode) {
        try {
            await fetchWithError('/mode', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `mode=${mode}`
            });
        } catch (error) {
            console.error('Failed to set mode:', error);
        }
    }

    // Save configuration
    async function saveConfig() {
        try {
            const formData = new FormData(document.getElementById('configForm'));
            await fetchWithError('/config', {
                method: 'POST',
                headers: {
                    'X-CSRF-TOKEN': csrfToken,
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams(formData)
            });
            alert('Configuration saved successfully!');
        } catch (error) {
            logError('Failed to save configuration: ' + error);
        }
    }

    // Factory reset
    async function factoryReset() {
        if (confirm('Are you sure you want to reset to factory settings?')) {
            try {
                await fetchWithError('/factory-reset', {
                    method: 'POST',
                    headers: {
                        'X-CSRF-TOKEN': csrfToken,
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                });
                alert('Factory reset initiated. Device will restart.');
            } catch (error) {
                logError('Failed to initiate factory reset: ' + error);
            }
        }
    }

    // Initial update and start periodic updates
    updateStatus();
    setInterval(updateStatus, 10000);
    </script>
</body>
</html> 