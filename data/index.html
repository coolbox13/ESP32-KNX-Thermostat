<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset='utf-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <title>ESP32 KNX Thermostat</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>ESP32 KNX Thermostat</h1>

    <hr>
    <h2>Status</h2>
    <p>Temperature: <span id="temperature">--</span>Â°C</p>
    <p>Humidity: <span id="humidity">--</span>%</p>
    <p>Pressure: <span id="pressure">--</span> hPa</p>

    <hr>
    <h2>Control</h2>
    <p>
        Mode: 
        <select id="mode">
            <option value="off">Off</option>
            <option value="comfort">Comfort</option>
            <option value="eco">Eco</option>
        </select>
        <button onclick="setMode()">Set Mode</button>
    </p>
    <p>
        Setpoint: 
        <input type="number" id="setpoint" value="21.0" min="5" max="30" step="0.5">
        <button onclick="setSetpoint()">Set Temperature</button>
    </p>

    <hr>
    <h2>Configuration</h2>
    <form id="configForm">
        Device Name: <input type="text" id="deviceName" name="deviceName" value="ESP32 Thermostat"><br><br>
        Update Interval (ms): <input type="number" id="updateInterval" name="updateInterval" value="10000" min="1000" step="1000"><br><br>
        KNX Address: <input type="text" id="knxAddress" name="knxAddress" pattern="\d{1,2}\.\d{1,2}\.\d{1,3}" value="1.1.1"><br><br>
        <button type="button" onclick="saveConfig()">Save Configuration</button>
    </form>

    <hr>
    <h2>System</h2>
    <button onclick="factoryReset()">Factory Reset</button>
    <button onclick="location.reload()">Refresh Page</button>

    <hr>
    <div id="errorLog" class="error"></div>

    <script>
    // Simple error logging function
    function logError(error) {
        console.error(error);
        document.getElementById('errorLog').textContent = error.toString();
    }

    // Basic fetch wrapper with error handling
    async function fetchWithError(url, options = {}) {
        try {
            const response = await fetch(url, options);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return await response.json();
        } catch (error) {
            logError(error);
            throw error;
        }
    }

    // Update status values
    async function updateStatus() {
        try {
            const data = await fetchWithError('/status');
            document.getElementById('temperature').textContent = data.temperature.toFixed(1);
            document.getElementById('humidity').textContent = data.humidity.toFixed(1);
            document.getElementById('pressure').textContent = data.pressure.toFixed(1);
        } catch (error) {
            logError('Status update failed: ' + error);
        }
    }

    // Set temperature
    async function setSetpoint() {
        try {
            const value = document.getElementById('setpoint').value;
            await fetchWithError('/setpoint', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: `setpoint=${value}`
            });
            updateStatus();
        } catch (error) {
            logError('Failed to set temperature: ' + error);
        }
    }

    // Set mode
    async function setMode() {
        try {
            const mode = document.getElementById('mode').value;
            await fetchWithError('/mode', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: `mode=${mode}`
            });
            updateStatus();
        } catch (error) {
            logError('Failed to set mode: ' + error);
        }
    }

    // Save configuration
    async function saveConfig() {
        try {
            const form = document.getElementById('configForm');
            const data = new FormData(form);
            await fetchWithError('/save', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(Object.fromEntries(data.entries()))
            });
            alert('Configuration saved');
        } catch (error) {
            logError('Failed to save configuration: ' + error);
        }
    }

    // Factory reset
    async function factoryReset() {
        if (confirm('Are you sure you want to reset to factory defaults?')) {
            try {
                await fetchWithError('/reset', { method: 'POST' });
                location.reload();
            } catch (error) {
                logError('Failed to perform factory reset: ' + error);
            }
        }
    }

    // Initial update and start periodic updates
    updateStatus();
    setInterval(updateStatus, 10000);
    </script>
</body>
</html> 